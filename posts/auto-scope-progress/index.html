<!DOCTYPE html>
<html prefix="" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Looking at microscope slides with computer vision | Python Friends</title>
<link href="../../assets/css/all.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href=".">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-84570235-4"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-84570235-4');
</script><meta name="author" content="Wytamma">
<meta name="robots" content="noindex">
<meta property="og:site_name" content="Python Friends">
<meta property="og:title" content="Looking at microscope slides with computer vision">
<meta property="og:url" content="/posts/auto-scope-progress/">
<meta property="og:description" content="We are making progress on the auto-scope project! The mechanical aspects of the microscope are all finished and working*. We’ve written most of the code to control the x, y, and z of the microscope an">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-10-16T00:00:00+10:00">
<meta property="article:tag" content="auto-scope">
<meta property="article:tag" content="cv2">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
            styles, `#sidebar-checkbox` for behavior. -->
    <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"><!-- Toggleable sidebar --><div class="sidebar" id="sidebar">
        
    <nav id="menu" role="navigation" class="sidebar-nav"><a class="sidebar-nav-item" href="../../">Home</a>
        <a class="sidebar-nav-item" href="../../pages/about/">About</a>
        <a class="sidebar-nav-item" href="../../archive.html">Archive</a>
        <a class="sidebar-nav-item" href="../../categories/">Tags</a>
        <a class="sidebar-nav-item" href="https://github.com/python-friends/">GitHub</a>
    
    
    </nav>
</div>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          
    <h3 id="brand" class="masthead-title">
      <a href="../../" title="Python Friends" rel="home">Python Friends</a>
    </h3>

        </div>
      </div>

      <div class="container content" id="content">
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="post-title p-name entry-title" itemprop="headline name"><a href="." class="u-url">Looking at microscope slides with computer vision</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Wytamma</span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="post-date published dt-published" datetime="2018-10-16T00:00:00+10:00" itemprop="datePublished" title="2018-10-16 00:00">2018-10-16 00:00</time></a></p>
        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>We are making progress on the auto-scope project! The mechanical aspects of the microscope are all finished and working*. We’ve written most of the code to control the x, y, and z of the microscope and we’re starting to move onto the whole slide stitching and machine learning aspects of the project.</p>
<p>Check out this (oldish) video of the stage moving around. Look at it go!</p>
<div class="youtube-video align-center">
<iframe width="100%" height="315" src="https://www.youtube-nocookie.com/embed/3XsQCkF1SrE?rel=0&amp;wmode=transparent" frameborder="0" allow="encrypted-media" allowfullscreen></iframe>
</div>
<!-- TEASER_END -->
<p>Currently, the microscope has stage control (x, y), focus control (z)  and a camera. We’re using an 8MP Raspberry Pi V2 camera to capture images of the slide. Two 28byj-48 stepper motors control the stage (one for x and one for y), and another stepper motor works the focus knob.</p>
<p>I’ve recently been working on the interactions between the camera and focus to capture tiles and enabling autofocusing. I thought I should detail some of the aspects of this part of the project while they are fresh in my mind.</p>
<p>Because we are using an <a class="reference external" href="https://en.wikipedia.org/wiki/Motor_control#Open_loop_control">open loop system</a> the microscope doesn’t have a way to tell it's current location (only how far it's moved from the starting position). To ensure reproducibility we always initialise the microscope with the focus at maximum height, that way the microscope knows one of its limits, and we can work down from this position.</p>
<p>When taking photos through the microscope with a camera like the RPi V2, the wide lens results in a lot of black surrounding the actual image we want to capture. Ideally, for image stitching, we'd like a square picture with no boarded. We could manually crop this additional border. However, we have <a class="reference external" href="https://xkcd.com/353/">Python</a>.</p>
<img alt="/images/auto-scope-cam/full.png" class="align-center" src="../../images/auto-scope-cam/full.png"><p>So, to automatically extract our square region of interest we first need to calculate a few parameters. To find the width of the circle, we mask the image with a back and white threshold and then move in from the sides until we hit something white. This gives us the diameter, easy.</p>
<img alt="/images/auto-scope-cam/width.png" class="align-center" src="../../images/auto-scope-cam/width.png"><p>To find the center of the circle we use a method from computer vision called <a class="reference external" href="https://www.learnopencv.com/find-center-of-blob-centroid-using-opencv-cpp-python/">blob centroid detection</a>. In short, we take the average position of all the points in the circle.</p>
<img alt="/images/auto-scope-cam/center.png" class="align-center" src="../../images/auto-scope-cam/center.png"><p>Using the diameter and centre point we can apply a bit of <a class="reference external" href="https://en.wikipedia.org/wiki/Special_right_triangle#45%C2%B0%E2%80%9345%C2%B0%E2%80%9390%C2%B0_triangle">trigonometry</a> to determine the coordinates of a square that is inscribed in the circle.</p>
<img alt="/images/auto-scope-cam/square.png" class="align-center" src="../../images/auto-scope-cam/square.png"><p>We can then feed this square information to the camera, that will zoom in and return nicely cropped images. The above description is implemented in the <cite>calculate_zoom</cite> method of the autoscope <cite>Camera</cite> class.</p>
<img alt="/images/auto-scope-cam/tile.png" class="align-center" src="../../images/auto-scope-cam/tile.png"><p>Now that we have a tile we need a way to tell if it’s in focus. There are many 'blurriness metrics' for example the <a class="reference external" href="https://www.pyimagesearch.com/2015/09/07/blur-detection-with-opencv/">variation of the Laplacian</a>. This method returns high values if an image contains high variance in rapid intensity change regions (associated with focused images).</p>
<img alt="/images/auto-scope-cam/focus.png" class="align-center" src="../../images/auto-scope-cam/focus.png"><p>To find the optimal focal height we need to map the focal plane and try to maximise the variation of the Laplacian (see bar plot). The initial scan of the focal plane is done in large steps down the focal plane until we find a peak. Once the course mapping is complete we then switch to fine steps to map the peak in detail. Now that we have a fine grain map of the focal plane peak we can simply move to focus with the highest variation. This course, fine, find algorithm is implemented in the <cite>auto_focus</cite> method of the autoscope <cite>Autoscope</cite> class.</p>
<p>You can check out all this camera code and more on <a class="reference external" href="https://github.com/python-friends/auto-scope">GitHub</a> or <cite>pip install opencv-contrib-python</cite> and try it yourself.</p>
<p>* My 3D printed gears suffer from a slight backlash that results in small errors when the stepper motors change direction. I think we should move to a timing belt system to prevent this in the future, however, slide scanning is still possible even with these errors.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/auto-scope/" rel="tag">auto-scope</a></li>
            <li><a class="tag p-category" href="../../categories/cv2/" rel="tag">cv2</a></li>
        </ul></nav></aside></article>
</div>
    </div>
    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    
    
    
            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
